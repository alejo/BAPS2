<!--
 * Manage network settings on the appliance
 *
 * Copyright (C) 2006 - 2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 * Brandon Kruse <bkruse@digium.com>
 *
 * All Rights Reserved.
 *
 * Distribution of this file is subject to the license
 * agreement you accepted when obtained and/or activated
 * the Digium product containing this file.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/rico.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/rico.css" media="all" rel="Stylesheet" type="text/css" />
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<script>
	var nwfields = ["HOSTNAME","NTP_ADDRESS","DHCP_WAN","IP_WAN","SUBNET_WAN","GATEWAY_WAN","DNS_WAN","GUI_WAN","DHCP_LAN","IP_LAN","SUBNET_LAN","DNS_LAN","SSHACCESS","TFTP_LAN","LEASE_LAN","MAX_LEASE","START_RANGE_LAN","END_RANGE_LAN","DOMAIN_LAN","status","save","cancel"];
	var widgets = {};
	var networkingcallbacks = {};

	networkingcallbacks.format = function(t, x) {
                if (t.name != 'general')
                        return null;
                return "General";
	}

	networkingcallbacks.loaded = function(t, x) {
               $('hiddennetworking').selectitem(0);
		enabledisable_dhcpwan();
		enabledisable_dhcplan();
		show_window(1);
		ASTGUI.events.add( _$('DHCP_WAN'), 'click', enabledisable_dhcpwan);
		ASTGUI.events.add( _$('DHCP_LAN'), 'click', enabledisable_dhcplan);
               parent.loadscreen(this);
	}


	function enabledisable_dhcpwan(){
		if( _$('DHCP_WAN').checked ){
			_$('IP_WAN').disabled = true;
			_$('SUBNET_WAN').disabled = true;
			_$('GATEWAY_WAN').disabled = true;
			_$('DNS_WAN').disabled = true;
		}else{
			_$('IP_WAN').disabled = false;
			_$('SUBNET_WAN').disabled = false;
			_$('GATEWAY_WAN').disabled = false;
			_$('DNS_WAN').disabled = false;
		}
	}

	function enabledisable_dhcplan(){
		if( _$('DHCP_LAN').checked ){
			_$('START_RANGE_LAN').disabled = false;
			_$('END_RANGE_LAN').disabled = false;
			_$('LEASE_LAN').disabled = false;
			_$('MAX_LEASE').disabled = false;

		}else{
			_$('START_RANGE_LAN').disabled = true;
			_$('END_RANGE_LAN').disabled = true;
			_$('LEASE_LAN').disabled = true;
			_$('MAX_LEASE').disabled = true;
		}
	}

	networkingcallbacks.savechanges = function(){
		_$('message_text').innerHTML ="Applying Changes ..... ";
		_$('status_message').style.display = "";
		var network_params = "/etc/asterisk/scripts/network.params";

		if(_$('DHCP_WAN').checked){var dwv = "on"; }else{var dwv = "off"; }
		if(_$('DHCP_LAN').checked){var dlv = "on"; }else{var dlv = "off"; }
		if(_$('SSHACCESS').checked){var ssv = "yes"; }else{var ssv = "no"; }
		if(_$('GUI_WAN').checked){var gwn = "on"; }else{var gwn = "off"; }

		var cmd1 = "echo \"DHCP_WAN=" + dwv + " IP_WAN=" + _$('IP_WAN').value + " SUBNET_WAN=" + _$('SUBNET_WAN').value + " GATEWAY_WAN=" + _$('GATEWAY_WAN').value + " DNS_WAN=" + _$('DNS_WAN').value + " GUI_WAN=" + gwn  + "\" > " + network_params;

		var cmd2 = "echo \" DHCP_LAN=" + dlv + " IP_LAN=" + _$('IP_LAN').value + " SUBNET_LAN=" + _$('SUBNET_LAN').value + " DNS_LAN=" + _$('DNS_LAN').value + "\" >> " + network_params;

		var cmd3 = "echo \" DNS_LAN=" + _$('DNS_LAN').value + " START_RANGE_LAN=" + _$('START_RANGE_LAN').value + " END_RANGE_LAN=" + _$('END_RANGE_LAN').value + " SSHACCESS=" + ssv + "\" >> " + network_params;

		var cmd4 = "echo \" HOSTNAME=" + _$('HOSTNAME').value + " LEASE_LAN=" + _$('LEASE_LAN').value + " NTP_ADDRESS=" + _$('NTP_ADDRESS').value + " TFTP_LAN=" + _$('TFTP_LAN').value + " DOMAIN_LAN=" + _$('DOMAIN_LAN').value + " MAX_LEASE=" + _$('MAX_LEASE').value + "\" >> " + network_params;

		var cmd5 = asterisk_guiNetworkSettings;

		parent.astmanEngine.run_tool(cmd1,onSuccess = function() {
			parent.astmanEngine.run_tool(cmd2,onSuccess = function() {
				parent.astmanEngine.run_tool(cmd3,onSuccess = function() {
					parent.astmanEngine.run_tool(cmd4,onSuccess = function() {
						setTimeout( function(){ _$('status_message').style.display = "none"; window.location.reload(); }, 3000 );
						parent.astmanEngine.run_tool(cmd5,onSuccess = function() { });
					});
				});
			});
		});

		/* Now networking.sh includes the network.params file
		   All the variables are now accessible through $name  */

	}


	function localajaxinit() {
		setWindowTitle("Network Settings");
		showdiv_statusmessage();

		for (var x=0; x < nwfields.length; x++ ) {
			widgets[nwfields[x]] = $(nwfields[x]);
			widgets[nwfields[x]].disabled = true;
		}

		ASTGUI.events.add( _$('IP_LAN') , 'change', function(){
			var t = Number( _$('IP_LAN').value.substr(0,3) );
 				if ( t >= 128 && t <= 191 ){ _$('SUBNET_LAN').value = "255.255.0.0"; return;}
				if ( t >= 0 && t <= 127 ){ _$('SUBNET_LAN').value = "255.0.0.0"; return;}
				if ( t >= 192  ){ _$('SUBNET_LAN').value = "255.255.255.0"; }
			}
		);
		ASTGUI.events.add( _$('IP_WAN') , 'change', function(){
			var t = Number( _$('IP_WAN').value.substr(0,3) );
 				if ( t >= 128 && t <= 191 ){ _$('SUBNET_WAN').value = "255.255.0.0"; return;}
				if ( t >= 0 && t <= 127 ){ _$('SUBNET_WAN').value = "255.0.0.0"; return;}
				if ( t >= 192  ){ _$('SUBNET_WAN').value = "255.255.255.0"; }
			}
		);
		var ssh_alert = function(){
			var msg = "Warning: the username and password for ssh does not correspond to \n"
				+ "the username and password that is used to log into the web interface.\n\n"
				+ "The default ssh username is 'root' and the default password is 'digium'. \n\n"
				+ "It is advised that you immediately change your ssh password with the \n"
				+ "'passwd' command and then click on the 'Save Configuration' button \n"
				+ "in the web gui to save your new ssh password.";
			if(_$('SSHACCESS').checked){alert(msg);}
		};
		ASTGUI.events.add( _$('SSHACCESS'), 'click', ssh_alert);

		parent.astmanEngine.config2list("networking.conf", $('hiddennetworking'), widgets, networkingcallbacks);
	}


function show_window(x){
	_$('tab1').className = "tab";
	_$('tab2').className = "tab";
	_$('tab3').className = "tab";

	switch(x){
		case 1:
			_$('tab1').className = "tabselected";
			_$('tab1').blur();
			_$('lan_div').style.display = "none";
			_$('wan_div').style.display = "none";
			_$('general_div').style.display="";
		break;
		case 2:
			_$('tab2').className = "tabselected";
			_$('tab2').blur();
			_$('lan_div').style.display = "none";
			_$('wan_div').style.display = "";
			_$('general_div').style.display="none";		
		break;
		case 3:
			_$('tab3').className = "tabselected";
			_$('tab3').blur();
			_$('lan_div').style.display = "";
			_$('wan_div').style.display = "none";
			_$('general_div').style.display="none";		
		break;
		case 4:
			window.location.href= "timezone.html";
		break;
	}
	
}
</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF">
<div class="mainscreenTitleBar">
	<span style="margin-left: 4px;font-weight:bold;">Networking Configuration</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="mailboxcontent">
<table class="mainscreenTable" align="center">
	<tr><td valign="top" align="center">

		<a href="#" class="tab" onclick="show_window(1);" id="tab1">General</a>&nbsp;&nbsp;
		<a href="#" class="tab" onclick="show_window(2);" id="tab2">Wan</a>&nbsp;&nbsp;
		<a href="#" class="tab" onclick="show_window(3);" id="tab3">Lan</a>&nbsp;&nbsp;
		<a href="#" class="tab" onclick="show_window(4);" id="tab3">TimeZone</a>&nbsp;&nbsp;
		<BR><BR>
		<div id="general_div">
		<table align="center">
			<TR>
				<TD><B>Hostname</B></TD>
				<TD><input type="text" id='HOSTNAME' size=14></TD>
			</TR>
			<TR>	<TD>NTP Server</TD>
				<TD><input type="text" id='NTP_ADDRESS' size=14></TD>
			</TR>
			<TR>	<TD><B>SSH</B></TD>
				<TD><input type="checkbox" id='SSHACCESS' value='yes'> Enable SSH</TD>
			</TR>
			<TR>	<TD height=20></TD>
				<TD></TD>
			</TR>
			<TR  onmouseover="show_tooltip('en', 'networking', 3);">	<TD valign="top" align="right">URL for Polycom <BR> auto provisioning:</TD>
				<TD>	<input type="text" id='TFTP_LAN' size=24></TD>
			</TR>
		</table>
		</div>

		<div id="wan_div">
		<table align="center">
			<TR>	<TD>DHCP</TD>
				<TD><input type="checkbox" id='DHCP_WAN'></TD>
			</TR>
			<TR>	<TD>IP</TD>
				<TD><input type="text" id='IP_WAN' size=14></TD>
			</TR>
			<TR>	<TD>SUBNET</TD>
				<TD><input type="text" id='SUBNET_WAN' size=14></TD>
			</TR>
			<TR>	<TD>GATEWAY</TD>
				<TD><input type="text" id='GATEWAY_WAN' size=14></TD>
			</TR>
			<TR>	<TD>DNS</TD>
				<TD><input type="text" id='DNS_WAN' size=14></TD>
			</TR>
			<TR>	<TD colspan=2 height=20></TD></TR>
			<TR>	<TD align=right><input type="checkbox" id='GUI_WAN'>&nbsp;</TD>
				<TD>Enable GUI on WAN interface</TD>
			</TR>
		</table>
		</div>

		<div id="lan_div">
		<table align="center">
			<TR>	<TD>Domain</TD>
				<TD><input type="text" id='DOMAIN_LAN'></TD>
			</TR>
			<TR>	<TD>Enable DHCP Server</TD>
				<TD><input type="checkbox" id='DHCP_LAN'></TD>
			</TR>
			<TR>	<TD>IP</TD>
				<TD><input type="text" id='IP_LAN' size=14></TD>
			</TR>
			<TR>	<TD>SUBNET</TD>
				<TD><input type="text" id='SUBNET_LAN' size=14></TD>
			</TR>
			<TR>	<TD>DNS</TD>
				<TD><input type="text" id='DNS_LAN' size=14></TD>
			</TR>
			<TR>	<TD>IP Start Range</TD>
				<TD><input type="text" id='START_RANGE_LAN' size=14></TD>
			</TR>
			<TR>	<TD>IP End Range</TD>
				<TD><input type="text" id='END_RANGE_LAN' size=14></TD>
			</TR>
			<TR>	<TD>Lease Time (in Miliseconds)</TD>
				<TD><input type="text" id='LEASE_LAN' size=14></TD>
			</TR>
			<TR>	<TD>Max Number of Leases</TD>
				<TD><input type="text" id='MAX_LEASE' size=14></TD>
			</TR>
		</table>
		</div>
		
		<div id="status" height=20></div>
		<BR>
		<input type="button" value="Save" id="save">&nbsp;&nbsp;<input type="button" value="Cancel" id="cancel">

		</td>
	</tr>
</table>
</div>
<select id="hiddennetworking" style="display:none"></select>
</body>
